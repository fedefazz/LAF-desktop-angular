<div class="scrap-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <mat-icon class="page-icon">inventory_2</mat-icon>
        Scrap
      </h1>
      <div class="header-actions">
        <button 
          mat-raised-button 
          color="warn" 
          class="delete-button"
          [disabled]="selection.selected.length === 0"
          (click)="deleteSelected()"
          matTooltip="Eliminar registros seleccionados">
          <mat-icon>delete</mat-icon>
          Borrar Registros ({{selection.selected.length}})
        </button>
        
        <button 
          mat-raised-button 
          color="primary"
          (click)="exportToExcel()"
          matTooltip="Descargar archivo Excel">
          <mat-icon>download</mat-icon>
          Descargar XLS
        </button>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <mat-card class="filters-card">
      <mat-card-content>
        <div class="filters-row">
          <!-- Search -->
          <mat-form-field class="search-field" appearance="outline">
            <mat-label>Buscar...</mat-label>
            <input 
              matInput 
              [(ngModel)]="searchQuery"
              (ngModelChange)="onSearchChange($event)"
              placeholder="Buscar en todos los campos">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <!-- Date From -->
          <mat-form-field appearance="outline">
            <mat-label>Fecha Desde</mat-label>
            <input 
              matInput 
              [matDatepicker]="pickerDesde"
              [(ngModel)]="fechaDesde">
            <mat-datepicker-toggle matIconSuffix [for]="pickerDesde"></mat-datepicker-toggle>
            <mat-datepicker #pickerDesde></mat-datepicker>
          </mat-form-field>

          <!-- Date To -->
          <mat-form-field appearance="outline">
            <mat-label>Fecha Hasta</mat-label>
            <input 
              matInput 
              [matDatepicker]="pickerHasta"
              [(ngModel)]="fechaHasta">
            <mat-datepicker-toggle matIconSuffix [for]="pickerHasta"></mat-datepicker-toggle>
            <mat-datepicker #pickerHasta></mat-datepicker>
          </mat-form-field>

          <!-- Apply Filters Button -->
          <button 
            mat-raised-button 
            color="accent"
            (click)="applyFilters()"
            matTooltip="Aplicar filtros">
            <mat-icon>filter_list</mat-icon>
            Filtrar
          </button>

          <!-- Clear Filters Button -->
          <button 
            mat-raised-button 
            color="warn"
            (click)="clearFilters()"
            [disabled]="!applyDateFilters && !searchQuery"
            matTooltip="Limpiar filtros y ver todos">
            <mat-icon>clear</mat-icon>
            Ver Todos
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Data Table -->
  <div class="table-container">
    <mat-card>
      <mat-card-content class="table-content">
        <!-- Loading Spinner - Solo cuando está cargando -->
        <div *ngIf="loading()" class="loading-container">
          <mat-spinner diameter="50"></mat-spinner>
          <span class="loading-text">Cargando datos...</span>
        </div>

        <!-- Contenido de la tabla - Solo cuando NO está cargando -->
        <ng-container *ngIf="!loading()">
          <!-- Table -->
          <div class="table-wrapper">
            <table 
              mat-table 
              [dataSource]="dataSource" 
              matSort
              (matSortChange)="onSortChange($event)"
              class="scrap-table">

            <!-- Checkbox Column -->
            <ng-container matColumnDef="select">
              <th mat-header-cell *matHeaderCellDef>
                <mat-checkbox 
                  (change)="$event ? masterToggle() : null"
                  [checked]="selection.hasValue() && isAllSelected()"
                  [indeterminate]="selection.hasValue() && !isAllSelected()"
                  [aria-label]="checkboxLabel()">
                </mat-checkbox>
              </th>
              <td mat-cell *matCellDef="let row">
                <mat-checkbox 
                  (click)="$event.stopPropagation()"
                  (change)="$event ? selection.toggle(row) : null"
                  [checked]="selection.isSelected(row)"
                  [aria-label]="checkboxLabel(row)">
                </mat-checkbox>
              </td>
            </ng-container>

            <!-- ID Column -->
            <ng-container matColumnDef="IdRegScrap">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
              <td mat-cell *matCellDef="let scrap">{{scrap.IdRegScrap}}</td>
            </ng-container>

            <!-- Fecha Column -->
            <ng-container matColumnDef="Fecha">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha</th>
              <td mat-cell *matCellDef="let scrap">{{formatDateTime(scrap.Fecha)}}</td>
            </ng-container>

            <!-- OP Column -->
            <ng-container matColumnDef="NumOP">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>OP</th>
              <td mat-cell *matCellDef="let scrap">{{scrap.NumOP}}</td>
            </ng-container>

            <!-- Maquina Column -->
            <ng-container matColumnDef="Maquina">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Máquina</th>
              <td mat-cell *matCellDef="let scrap">
                {{scrap.PSSMaquinas?.Descripcion || '-'}}
              </td>
            </ng-container>

            <!-- Maquina Imputa Column -->
            <ng-container matColumnDef="MaquinaImputa">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Máquina Imputa</th>
              <td mat-cell *matCellDef="let scrap">
                {{scrap.IdMaqImputaScrapName || '-'}}
              </td>
            </ng-container>

            <!-- Actividad Column -->
            <ng-container matColumnDef="Actividad">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Actividad</th>
              <td mat-cell *matCellDef="let scrap">
                {{scrap.PSSActividades?.Descripcion || '-'}}
              </td>
            </ng-container>

            <!-- Operador Column -->
            <ng-container matColumnDef="Operador">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Operador</th>
              <td mat-cell *matCellDef="let scrap">
                {{formatOperadorName(scrap.PSSOperadores)}}
              </td>
            </ng-container>

            <!-- Origen Scrap Column -->
            <ng-container matColumnDef="OrigenScrap">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Origen Scrap</th>
              <td mat-cell *matCellDef="let scrap">
                {{scrap.PSSOrigenesScrap?.Descripcion || '-'}}
              </td>
            </ng-container>

            <!-- Tipo Material Column -->
            <ng-container matColumnDef="TipoMaterial">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo Material</th>
              <td mat-cell *matCellDef="let scrap">
                {{scrap.PSSTiposMaterial?.Descripcion || '-'}}
              </td>
            </ng-container>

            <!-- Peso Column -->
            <ng-container matColumnDef="Peso">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Peso (kg)</th>
              <td mat-cell *matCellDef="let scrap" class="numeric-cell">
                {{scrap.Peso | number:'1.2-2'}}
              </td>
            </ng-container>

            <!-- Observaciones Column -->
            <ng-container matColumnDef="Observaciones">
              <th mat-header-cell *matHeaderCellDef>Observaciones</th>
              <td mat-cell *matCellDef="let scrap" class="observations-cell">
                <span 
                  [matTooltip]="scrap.Observaciones || ''"
                  [matTooltipDisabled]="!scrap.Observaciones">
                  {{scrap.Observaciones || '-'}}
                </span>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let scrap" class="actions-cell">
                <button 
                  mat-icon-button 
                  color="primary"
                  (click)="editScrap(scrap)"
                  matTooltip="Editar registro">
                  <mat-icon>edit</mat-icon>
                </button>
                <button 
                  mat-icon-button 
                  color="warn"
                  (click)="deleteSingleScrap(scrap)"
                  matTooltip="Eliminar registro">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <!-- Header and Row Definitions -->
            <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
            <tr 
              mat-row 
              *matRowDef="let row; columns: displayedColumns;"
              [class.selected-row]="selection.isSelected(row)"
              class="data-row">
            </tr>

            <!-- No Data Row -->
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell no-data-cell" [attr.colspan]="displayedColumns.length">
                <div class="no-data-message">
                  <mat-icon class="no-data-icon">inventory_2</mat-icon>
                  <span>No se encontraron registros</span>
                  <small *ngIf="searchQuery">Intente modificar los criterios de búsqueda</small>
                </div>
              </td>
            </tr>
          </table>
        </div>

        <!-- Paginator -->
        <mat-paginator 
          #paginator
          [length]="filteredRecords()"
          [pageSize]="pageSize"
          [pageIndex]="pageIndex"
          [pageSizeOptions]="pageSizeOptions"
          [showFirstLastButtons]="true"
          (page)="onPageChange($event)"
          aria-label="Seleccionar página">
        </mat-paginator>
        </ng-container>
      </mat-card-content>
    </mat-card>
  </div>
</div>
